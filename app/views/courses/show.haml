</div>
- set_var 'events', @events.map{|e| {title: e.room.office.name  + " " + e.room.name + " " + e.member.to_s, start: e.starts_at, end: e.ends_at, url: edit_event_path(e), color: e.room.name}}
.container.text-center
  = link_to "<i class='fa fa-edit'></i> Edit course".html_safe, edit_course_path(@course), class: 'btn btn-success'

  = link_to "<i class='fa fa-calendar-plus-o'></i> Add events".html_safe, edit_events_course_path(@course), class: 'btn btn-primary'

  %button.btn.btn-success{"data-target" => ".bs-example-modal-sm-2", "data-toggle" => "modal", :type => "button"} <i class='fa fa-user-plus'></i> New enrollment
  .modal.fade.bs-example-modal-sm-2{"aria-labelledby" => "mySmallModalLabel", :role => "dialog", :tabindex => "-1"}
    .modal-dialog.modal-sm
      .modal-content
        .well
          %h1 New enrollment
          = simple_form_for @enrollment do |f|
            = f.input :coupon_id
            /= f.input :enrollment_id
            /= f.association :enrollment
            /= f.input  :course_id
            /= f.input  :client_id
            /= f.select :client_id, @Client.all.map{|c| [c, c.id]}, {},class: 'selectize'
            = f.label :Client
            = f.select :client_id, Client.all.map{|c| [c, c.id]}, {},class: 'selectize'
            /= f.select :enrollment_id, @course.enrollments.map{|c| [c, c.id]}, {},class: 'selectize'
            /in the following we want to input the enrollment id, not client id
            /= f.select :enrollment_id, @course.clients.map{|c| [c, c.id]}, {},class: 'selectize'
            /= f.input :member_id
            = f.input :member_id, :as => :hidden
            = f.submit
            /= f.button :submit, class: 'btn btn-primary btn-block'
            = f.input :course_id, input_html: {value: @course.id}, as: :hidden

  = link_to "<i class='fa fa-calendar-check-o'></i> Mark attendances".html_safe, edit_attendances_course_path(@course), class: 'btn btn-primary'

  %button.btn.btn-success{"data-target" => ".bs-example-modal-sm", "data-toggle" => "modal", :type => "button"} <i class='fa fa-credit-card'></i> Add payment
  .modal.fade.bs-example-modal-sm{"aria-labelledby" => "mySmallModalLabel", :role => "dialog", :tabindex => "-1"}
    .modal-dialog.modal-sm
      .modal-content
        .well
          %h1 New payment
          = simple_form_for @payment do |f|
            = f.input :amount
            = f.label :Client
            = f.select :enrollment_id, @course.enrollments.map{|c| [c, c.id]}, {},class: 'selectize'
            = f.input :member_id, :as => :hidden
            = f.input :payment_type, collection: [ "cash", "card"], selected: "cash"
            = f.association :office
            = f.submit
            /= f.button :submit, class: 'btn btn-primary btn-block'

  = link_to 'All courses', courses_path, class: "btn btn-default"

%br
.row
.col-md-3
  #accordion.panel-group
    .panel.panel-default
      .panel-heading
        %h4.panel-title
          %a.accordion-toggle{"data-toggle" => "collapse", :href => "#collapseOne"}
            %b Course info
      #collapseOne.panel-collapse.collapse.in
        .panel-body
          .text-center

          %p
            %b Course name:
            = @course.name
          %p
            %b Product:
            = @course.product
          %p
            %b Price of 1 lesson:
            = @course.product.member_price
          %p
            %b Lesson quantity:
            = @course.product.event_quantity
          %p
            %b Total price:
            = @course.product.productprice
          %p
            %b Lesson duration:
            = @course.product.event_length
          %p
            %b Attr1:
            = @course.attr1
          %p
            %b Attr2:
            = @course.attr2
          %p
            %b Attr3:
            = @course.attr3
          %table.table.table-hover.table-condensed.table-responsive.table-bordered
            %thead
              %tr
                /%th Total attendances:
                /%th Clients registered:
                %th Total paid for group
                %th.bg-success Total price of attendances:
                %th.bg-danger Expected to be paid
            %tbody
              %tr
                /%td= @course.attendances.count
                /%td= @course.clients.count
                %td= @enrollmentpaymentz
                %td.bg-success= @totalduepaymentguest
                %td.bg-danger= @totalduepaymentguest - @enrollmentpaymentz
.col-sm-9
  #accordion.panel-group
    .panel.panel-default
      .panel-heading
        %h4.panel-title
          %a.accordion-toggle{"data-toggle" => "collapse", :href => "#collapsetwo"}
            %b Details
      #collapsetwo.panel-collapse.collapse.in
        .panel-body
          %ul.nav.nav-tabs
            %li.active
              %a{"data-toggle" => "tab", :href => "#Calendar"} Calendar
            %li
              %a{"data-toggle" => "tab", :href => "#Eventsall"}
                All events:
                = @past_events.count
            %li
              %a{"data-toggle" => "tab", :href => "#Eventspast"}
                Past events:
                = @past_events.count
            %li
              %a{"data-toggle" => "tab", :href => "#Eventsfuture"}
                Future events:
                = @future_events.count
            %li
              %a{"data-toggle" => "tab", :href => "#Enrollments"}
                Enrollments:
                = @totalenrollments
            %li
              %a{"data-toggle" => "tab", :href => "#Payments"} 
                Payments:
                = @totalpayments
          .tab-content
            #Calendar.tab-pane.fade.in.active
              %br
              %div#calendar
            #Eventsall.tab-pane.fade
              %p
              %table.table.table-hover.table-condensed.table-responsive.table-bordered
                - @events.collect{|p| [p.startnice, p.duration, p.room, p.member, p.eventused]}.transpose.each do |line|
                  %tr
                    - line.each do |cell|
                      %td= cell


                      /- event.attendances.each do |attendance|
                      /  %tr.bg-warning
                      /    %td= link_to attendance.client, client_path(attendance.client), class: 'btn btn-default btn-xs', :style=>'color: blue;'
                      /    %td= attendance.attendance_rate
                      /    %td= attendance.duepayment


            #Eventspast.tab-pane.fade
              %p
              %table.table.table-hover.table-condensed.table-responsive.table-bordered
                %thead
                  %tr
                    %th Starts at
                    %th Duration
                    %th Room
                    %th Responsible
                    %th Edit event
                    %th PriceOffAllEvetnAttendances
                %tbody
                  - @past_events.each do |event|
                    %tr.bg-danger
                      %td= event.starts_at
                      %td= event.course.product.event_length
                      %td= event.room
                      %td= link_to event.member, member_path(event.member), class: 'btn btn-default btn-xs', :style=>'color: blue;'
                      %td= link_to 'Edit', edit_event_path(event), class: 'btn btn-default btn-xs'
                      %td= event.eventused
                      %thead
                        %tr.bg-warning
                          %th Client
                          %th Attendance
                      %tbody
                      - event.attendances.each do |attendance|
                        %tr.bg-warning
                          %td= link_to attendance.client, client_path(attendance.client), class: 'btn btn-default btn-xs', :style=>'color: blue;'
                          %td= attendance.attendance_rate
                          %td= attendance.duepayment
            #Eventsfuture.tab-pane.fade
              %p
              %table.table.table-hover.table-condensed.table-responsive.table-bordered
                %thead
                  %tr
                    %th Starts at
                    %th Duration
                    %th Room
                    %th Responsible
                    %th Edit event
                %tbody
                  - @future_events.each do |event|
                    %tr.bg-danger
                      %td= event.starts_at
                      %td= event.course.product.event_length
                      %td= event.room
                      %td= link_to event.member, member_path(event.member), :style=>'color: blue;', class: 'btn btn-default btn-xs'
                      %td= link_to 'Edit', edit_event_path(event), class: 'btn btn-default btn-xs'
                      %thead
                        %tr.bg-warning
                          %th Client
                          %th Attendance
                      %tbody
                      - event.attendances.each do |attendance|
                        %tr.bg-warning
                          %td= link_to attendance.client, client_path(attendance.client), :style=>'color: blue;', class: 'btn btn-default btn-xs'
                          %td= attendance.attendance_rate
                          %td= attendance.duepayment
            #Enrollments.tab-pane.fade
              %p
              %table.table.table-hover.table-condensed.table-responsive.table-bordered
                %thead
                  %tr
                    %th EnrollID
                    %th Client
                    %th Paid
                    %th Used
                    %th ToPay
                    /%th Coupon
                    %th Member
                %tbody
                  - @enrollments.each do |enrollment|
                    %tr
                      %td= enrollment.id
                      %td= link_to enrollment.client, client_path(enrollment.client), :style=>'color: blue;'
                      %td= enrollment.enrpaid
                      %td= enrollment.enrused
                      %td= enrollment.enrbalance
                      /%td= link_to enrollment.member, member_path(enrollment.member), :style=>'color: blue;'
                      %td= enrollment.member
                      %td= enrollment.attendances.count
                      /%thead
                      /  %tr.bg-warning
                      /    /%th
                      /    %th PayID
                      /    %th PayAmount
                      /%tbody
                      /- enrollment.payments.each do |payment|
                      /  %tr.bg-warning
                      /    %td= payment.id
                      /    %td= payment.amount
            #Payments.tab-pane.fade
              %p
              %table.table.table-hover.table-condensed.table-responsive.table-bordered
                %thead
                  %tr
                    %th PayID
                    %th.bg-success Amount
                    %th Client/enrollment
                    %th CreatedAt
                    %th Office
                    %th Payment type
                    %th Actions
                %tbody
                  - @payments.each do |payment|
                    %tr
                      %td= payment.id
                      %td= payment.amount
                      %td= link_to payment.enrollment, client_path(payment.enrollment.client), class: 'btn btn-default btn-xs'
                      /%td= payment.enrollment.client
                      %td= payment.created
                      %td= payment.office
                      %td= payment.payment_type
                      %td
                        = link_to 'Edit', edit_payment_path(payment), class: 'btn btn-default btn-xs'
                        = link_to 'Destroy', payment, :method => :delete, :data => { :confirm => 'Are you sure?' }, class: 'btn btn-danger btn-xs'
